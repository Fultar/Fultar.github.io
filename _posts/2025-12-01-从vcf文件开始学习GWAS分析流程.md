---
layout: post
title: "从VCF文件开始进行GWAS分析"
date: 2025-12-01
categories: [生物信息学, GWAS]
tags: [GWAS, VCF file]
---
# 一、VCF文件转格式和位点过滤

## 1.1 vcf文件转为plink格式

原始vcf文件一般较大，包含了很多不必要的信息，可以删去没用的信息来缩小体积，加快后续分析的速度
```
# 压缩vcf文件
nohup tar -zcvf ZY-Fu-all_sample.vcf.tar.gz ZY-Fu-all_sample.vcf&


# vcftools粗过滤
## 过滤缺失率在50%以上的位点
nohup vcftools --vcf ../rawdata/ZY-Fu-all_sample.vcf --max-missing 0.5 --recode --recode-INFO-all --out ZY-Fu-all_sample_vcftoolsFilte >nohup.log 2>error.log&

## Outputting VCF file...
## After filtering, kept 1612479 out of a possible 80162632 Sites
## Run Time = 5304.00 seconds

# 删除vcf表头多余信息
grep -v '^##' ZY-Fu-all_sample_vcftoolsFilte.recode.vcf > ZY-Fu_vcftoolsFilte.vcf

#vcf转PLINK
plink --vcf ../rawdata/ZY-Fu_vcftoolsFilte.vcf --recode --out ZY-Fu-all_sample --allow-extra-chr 

## Total genotyping rate is 0.712254.
## 1612479 variants and 289 people pass filters and QC.

```

## 1.2 位点过滤

过滤质量决定了后续分析结果的可靠性。由于本人使用的是水产鱼类的数据，样本量较小，表型测试也不像人类疾病标准化，所以没进行过于严格的过滤，而是采用略宽泛的标准过滤低质量SNP，尽可能保留效应SNPs。

```
#ped/map转为二进制格式 bed/bim/fam
plink --file ZY-Fu-all_sample --make-bed --out ZY-Fu-all_sample --allow-extra-chr

#检查缺失信息
plink --file ZY-Fu-all_sample --missing --allow-extra-chr 
wc -l plink.lmiss ; 22664285 plink.lmiss

## 过滤SNP缺失率高于10%的SNP
plink --bfile ZY-Fu-all_sample --geno 0.10 --make-bed --out ZY-Fu-all_sample_geno --chr-set 24 --double-id --allow-extra-chr

## 1284319 variants removed due to missing genotype data (--geno).
## 328160 variants and 289 samples pass filters and QC.

# 过滤maf率低于5%的SNP
plink --bfile ZY-Fu-all_sample_geno --maf 0.05 --make-bed --out ZY-Fu-all_sample_geno_maf --chr-set 24 --double-id --allow-extra-chr

## 225659 variants removed due to minor allele threshold(s)
## 102501 variants and 289 samples pass filters and QC.

# 哈温平衡过滤
plink --bfile ZY-Fu-all_sample_geno_maf --hwe 1e-4 --make-bed --out ZY-Fu-all_sample_geno_maf_hwe --chr-set 24 --double-id --allow-extra-chr
## 85636 variants and 289 samples pass filters and QC.

## 构建pca文件，作为协变量加入模型
plink --allow-extra-chr --allow-no-sex --threads 20 -bfile ZY-Fu-all_sample_geno_maf_hwe --pca 3 --out ./pca/ZY-Fu-pca
```

# 二、GWAS模型构建

通过以上的过滤，我们得到了较高质量的SNPs，这些可靠的SNPs能用于后续的建模分析。

plink自带的是广义线性模型，我们可以尝试做下。

## 2.1 LM assoc模型

如果表型是连续型变量，可以使用assoc模型进行线性回归分析。
```
plink --bfile ZY-Fu-all_sample_geno_maf_hwe --assoc --pheno ZY-Fugu-phenotype.txt  --out ZY_Fugu_assoc_results --allow-extra-chr --allow-no-sex


## 表型文件前两列为样本名和家系，第三列为表型；如果没区分家系父母本的话，前两列的名字内容是一样的
$head ZY-Fugu-phenotype.txt
sample1 sample1 10
sample2 sample2 14
sample3 sample3 19

```

## 2.2 LM logistics模型

logistics模型针对的是二分类表型，需要你的表型为“0”或“1”分类。
```
plink --bfile ZY-Fu-all_sample_geno_maf_hwe --logistic --pheno ZY-Fugu-phenotype.txt  --out ZY_Fugu_assoc_results --allow-extra-chr --allow-no-sex

```

## 2.3 LMM模型

从plink的广义线性模型结果中可以看到，GLM其实并不能很好的反应基因型与表型的关系。

这就需要混合线性模型了，它通过引入遗传关系矩阵（kinship marix），排除因为样本间因为相似的遗传背景导致类似的表型。

我这里使用gemma构建LMM，GCTA也可以构建LMM。

```
# 合法表型文件
## gemma表型只要第三列的表型值，前两列的样本名不需要
awk '{print $3}' ../ZY-Fugu-phenotype.txt>./ZY-Fugu-phenotype.gemma.txt

# 输出亲缘关系矩阵
gemma-0.98.5-linux-static-AMD64 -bfile ../ZY-Fu-all_sample_geno_maf_hwe -p ZY-Fugu-phenotype.gemma.txt -gk 2 -o ZY_Fugu_kinship

## 生成的kinship矩阵在 output/ 路径下

# LMM模型分析
gemma-0.98.5-linux-static-AMD64  -bfile ../ZY-Fu-all_sample_geno_maf_hwe -k output/ZY_Fugu_kinship.sXX.txt -lmm 1 -p ZY-Fugu-phenotype.gemma.txt -o ZY_Fugu_LMM

```

